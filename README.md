# README (ストーリー作成サイト)

本リポジトリは、Instagram風のストーリーを作成・管理・閲覧するWebアプリケーションのサンプルコード一式です。  
管理者がアカウントを作成し、アカウントごとにストーリー（画像・動画）を追加・編集・削除でき、一般ユーザーはログイン不要でストーリーを閲覧できます。

---

## 1. 構成ファイル

### `.htaccess`
ApacheのURLリライト設定を行うファイルです。  
`https://instagran.azurewebsites.net/XXXXXX` へのアクセスを、内部的に `index.php?account=XXXXXX` にルーティングします。

### `index.php`
ストーリー閲覧用のメインページです。  
`.htaccess` によりリライトされたパラメーター（`?account=XXXXXX`）を取得し、該当アカウントのストーリーを表示します。  
ストーリー閲覧画面では、Instagram風UIを実装し、10秒ごとの自動切り替えやリンクテキスト、閲覧数のカウントなどを行います。

### `admin.php`
管理画面です。  
- 管理者がID・パスワードでログインし、アカウントやストーリーのCRUDを行います。
- ストーリー画像/動画のアップロード、リンク設定、閲覧数や遷移数の解析表示を備えています。
- 初回ログイン時はパスワード変更を強制する機能があります。
- `?redirect_account=XXXXXX&redirect_story=N` へのアクセスでリダイレクト数をカウントし、リンク先へ飛ばす仕組みを提供します。
- `?stats=1` でアクセス数解析画面を表示し、ストーリーごとの閲覧数・遷移数を確認できます。

### `account.json`
管理者アカウント・各アカウント・ストーリー情報などを保存するJSONファイルです。  
試用版のため、IDとパスワードは平文で保持します。

### `system.json`
システム管理者やレベル設定などを行うためのJSONファイルです。  
- システム管理者の認証情報、管理者レベルと上限アカウント数などを保存します。

### `uploads/` ディレクトリ
- `uploads/icons/` … アカウントのアイコン画像を保存します。  
- `uploads/stories/XXXXXX/` … ストーリー画像や動画を保存します（アカウントID `XXXXXX` ごとにフォルダを作成）。

### `data/` ディレクトリ
- `data/XXXXXX/` … そのアカウントのストーリー閲覧数・遷移数などを保持する `data.json` を格納します。

---

## 2. セットアップ

1. **ApacheでRewriteを有効化**  
   - `.htaccess` が機能するよう、Apacheの設定で `mod_rewrite` を有効にしてください。
   - `.htaccess` 内で `RewriteEngine On` と設定済みなので、サーバーが `.htaccess` を読み込むようにしておきます。

2. **ファイル配置**  
   - `admin.php`, `index.php`, `.htaccess`, `account.json`, `system.json` を同じディレクトリに配置します。
   - `uploads/` と `data/` ディレクトリを作成し、書き込み可能なパーミッションに設定してください。

3. **初回アクセス**  
   - ブラウザで `admin.php` にアクセスすると、ログイン画面が表示されます。
   - もし初期管理者がいない場合は自動的に `admin` / `admin` で作成されます。
   - ログイン成功後、パスワード未変更なら変更画面が表示されるので、新しいID/パスワードを設定してください。

---

## 3. 使い方

### ストーリー閲覧

- 一般ユーザーは `https://instagran.azurewebsites.net/XXXXXX` にアクセスするだけでストーリーを閲覧できます。  
- `.htaccess` により `index.php?account=XXXXXX` に内部リダイレクトされ、`index.php` 側で該当アカウントのストーリーをInstagram風UIで表示します。  
- 上部には10秒間のプログレスバー、右上にバツボタン、左上にはアカウントのアイコンと指定のIDが表示されます。  
- ストーリーは画像・動画に対応し、10秒ごとに自動で次のストーリーへ切り替わります。  

### 管理者機能

1. **ログイン**  
   - `admin.php` にアクセスし、管理者ID・パスワードでログインします。  
   - 初回ログイン時はパスワード変更を強制されます。

2. **アカウント作成・編集・削除**  
   - アカウントに名前とアイコン画像を設定し、`account.json` に反映。  
   - アカウント削除時にはストーリーや画像もまとめて削除されます。

3. **ストーリー作成・編集・削除**  
   - 作成時に画像or動画ファイルをアップロードして9:16などの比率に整形します。  
   - 編集ではURL、テキスト、画像/動画を更新可能。  
   - 削除時には該当ファイルをサーバーから除去し、JSONからも削除します。

4. **リンク位置設定**  
   - ストーリー画像上でクリックされた位置を取得し、X/Y比率を算出して保存。  
   - 閲覧画面で指定座標にテキストリンクを表示し、タップすると内部リダイレクトでリンク先に飛ばします。

5. **アクセス解析 (stats機能)**  
   - `?stats=1` を付けて `admin.php` にアクセスすると、ストーリーの閲覧数 (`access_count`) と遷移数 (`redirect_count`) を一覧表示します。  
   - `data/XXXXXX/data.json` に数値が保存され、管理者画面で可視化されます。

6. **リダイレクト機能**  
   - ストーリー内リンクをタップすると `?redirect_account=&redirect_story=` へアクセス → リダイレクト数をカウントし、本来のURLへ即時転送します。

---

## 4. 留意事項

- **セキュリティ**  
  - 本番運用の場合はID/パスワードのハッシュ化やHTTPS運用が必須です。  
  - JSONファイルやアップロードフォルダは外部から参照されないよう、適切な権限設定を行ってください。

- **運用・保守**  
  - `account.json`, `system.json`, `data/`, `uploads/` を定期バックアップすることで、万一の際に復旧が可能です。  
  - 画像/動画が増えすぎたら古いものをアーカイブして容量を確保するなどの運用ルールを設けてください。

- **拡張性**  
  - 期間別アクセス集計や複数管理者による共同編集機能など、追加要件は随時拡張できます。  
  - コードをGit等でバージョン管理しておくと、変更履歴を追跡しやすくなります。

以上が本システムのREADMEです。詳細な仕様・要件は別途「要件定義書」を参照してください。
